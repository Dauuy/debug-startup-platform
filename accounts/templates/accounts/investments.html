{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Портфель{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/investments_styles.css' %}">
{% endblock %}

{% block content %}
  {% if user.is_authenticated and user.role.role_name == 'investor' %}
    <div class="portfolio-container">
      <!-- Верхняя секция с аналитикой -->
      <div class="analytics-section">
        <div class="analytics-left">
          <div class="portfolio-image-container">
            {# <img src="{% static 'accounts/images/layout/planets_portfolio.png' %}" alt="Portfolio Planets" class="portfolio-image"> #}
            <button class="portfolio-image-fullscreen-btn">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <!-- Категории с радиальными диаграммами -->
          <div class="categories-radial-section">
            <h3 class="categories-radial-title">Категории</h3>
            <div class="categories-radial-grid">
              <!-- Пример категории (нужно будет генерировать динамически) -->
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="70">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">70%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="90">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">90%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="60">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">60%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="40">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">40%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
               <div class="category-radial-item">
                <div class="radial-chart" data-percentage="70">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">70%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="60">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">60%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="40">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">40%</div>
                </div>
                <span class="category-radial-name">Медицина</span>
              </div>
              <!-- Категория "Все" -->
              <div class="category-radial-item category-all">
                <div class="radial-chart-all">
                   <i class="fas fa-ellipsis-h"></i>
                </div>
                <span class="category-radial-name">Все</span>
              </div>
              {% comment %}
              {% for category in investment_categories %} {# Пример цикла #}
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="{{ category.percentage }}">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">{{ category.percentage }}%</div>
                </div>
                <span class="category-radial-name">{{ category.name }}</span>
              </div>
              {% empty %}
                <p>Нет данных по категориям.</p>
              {% endfor %}
              {% endcomment %}
            </div>
          </div>
        </div>
        <div class="analytics-content">
          <div class="analytics-header">
              <h1 class="analytics-title">Аналитика</h1>
              <div class="analytics-controls">
                  <select class="month-select">
                      <option value="март">Март</option>
                      <option value="апрель">Апрель</option>
                      <option value="май">Май</option>
                      {# Другие месяцы #}
                  </select>
                  <button class="analytics-options-btn">
                      <i class="fas fa-ellipsis-v"></i>
                  </button>
              </div>
          </div>

          <div class="stats-overview">
            <div class="stat-item">
              <span class="stat-label">Кол-во стартапов</span>
              <div class="stat-value-box dark-box">{{ startups_count|default:"12" }}</div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Общая сумма инвестирования</span>
              <div class="stat-value-box blue-box">{{ total_investment|default:"3 654 765" }} ₽</div>
            </div>
          </div>

          <div class="stats-details">
             <div class="stat-item detail-item">
              <span class="stat-label">Макс. сумма инвестирования</span>
              <span class="stat-value-simple">{{ max_investment|default:"3 654 765" }} ₽</span>
            </div>
            <div class="stat-item detail-item">
              <span class="stat-label">Мин. сумма инвестирования</span>
              <span class="stat-value-simple">{{ min_investment|default:"3 654 765" }} ₽</span>
            </div>
          </div>

          <!-- График -->
          <div class="analytics-chart-container">
            <div class="chart-placeholder">
              </div>
            <span class="chart-title-overlay">Аналитика этого месяца</span>

          </div>

          <button class="download-report-btn">Скачать отчет</button>
        </div>
      </div>
      
      <!-- Раздел Мои стартапы -->
      <div class="my-startups-section">
        <div class="startups-header">
          <div class="startups-titles">
            <h2 class="startups-title-main">МОИ</h2>
            <h2 class="startups-title-sub">СТАРТАПЫ</h2>
          </div>
          <div class="total-investment">
            <span class="investment-label">инвестировано</span>
            <div class="investment-amount">{{ total_investment|default:"3 675 998" }}</div> {# Отображаем реальную сумму #}
          </div>
        </div>

        <div class="startups-filters">
          <div class="startups-search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Поиск" id="startup-search" class="startups-search-input">
          </div>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">Все</button>
            <div class="filter-dropdown-wrapper">
              <button class="filter-btn filter-btn-dropdown" data-filter="category">Категория <i class="fas fa-chevron-down"></i></button>
              {# Здесь может быть выпадающий список категорий #}
              <div class="filter-dropdown-content">
                <a href="#" data-category="medicine">Медицина</a>
                <a href="#" data-category="it">IT</a>
                <a href="#" data-category="finance">Финансы</a>
                {# Другие категории #}
              </div>
            </div>
            <button class="filter-btn" data-filter="new"><i class="fas fa-sort-amount-up"></i> Новые</button>
          </div>
        </div>

        <div class="startups-grid">
          {# Пример карточки стартапа (нужно будет генерировать динамически) #}
          <div class="startup-card" data-category="Медицина" data-name="Ромашка">
            <div class="startup-card-left">
                <img src="{% static 'accounts/images/layout/planet_1.png' %}" alt="Startup Planet" class="startup-planet-img">
                 <div class="startup-name">Ромашка</div>
                <div class="startup-rating">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i> {# Пример полузвезды #}
                </div>
                 <button class="startup-chat-btn"><i class="fas fa-comment-dots"></i></button>
            </div>
            <div class="startup-card-right">
                <div class="startup-detail-row">
                    <span class="detail-label">Статус</span>
                    <span class="detail-value status-active">Активен</span>
                </div>
                <div class="startup-detail-row">
                    <span class="detail-label">Собранная сумма:</span>
                    <span class="detail-value">345 678 ₽</span>
                </div>
                <div class="startup-detail-row">
                    <span class="detail-label">Цель финансирования:</span>
                    <span class="detail-value">345 678 ₽</span>
                </div>
                <div class="startup-category-tag">Медицина</div>
            </div>
          </div>

          <div class="startup-card" data-category="IT" data-name="Аптека+"> {# Пример другой карточки #}
             <div class="startup-card-left">
                <img src="{% static 'accounts/images/layout/planet_2.png' %}" alt="Startup Planet" class="startup-planet-img">
                 <div class="startup-name">Аптека+</div>
                <div class="startup-rating">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="far fa-star"></i> {# Пустая звезда #}
                    <i class="far fa-star"></i>
                </div>
                 <button class="startup-chat-btn"><i class="fas fa-comment-dots"></i></button>
            </div>
            <div class="startup-card-right">
                <div class="startup-detail-row">
                    <span class="detail-label">Статус</span>
                    <span class="detail-value status-active">Активен</span>
                </div>
                <div class="startup-detail-row">
                    <span class="detail-label">Собранная сумма:</span>
                    <span class="detail-value">5 220 000 ₽</span>
                </div>
                <div class="startup-detail-row">
                    <span class="detail-label">Цель финансирования:</span>
                    <span class="detail-value">5 220 000 ₽</span>
                </div>
                <div class="startup-category-tag">IT</div>
            </div>
          </div>
          {# Добавить еще карточек или цикл Django #}
          {% comment %}
          {% for investment in user_investments %}
            <div class="startup-card" data-category="{{ investment.startup.category.name }}" data-name="{{ investment.startup.name }}">
              <div class="startup-card-left">
                  <img src="{{ investment.startup.planet_image.url }}" alt="{{ investment.startup.name }} Planet" class="startup-planet-img">
                  <div class="startup-name">{{ investment.startup.name }}</div>
                  <div class="startup-rating">
                      {# Логика для отображения звезд рейтинга #}
                  </div>
                  <button class="startup-chat-btn"><i class="fas fa-comment-dots"></i></button>
              </div>
              <div class="startup-card-right">
                  <div class="startup-detail-row">
                      <span class="detail-label">Статус</span>
                      <span class="detail-value status-{{ investment.startup.get_status_display|lower }}">{{ investment.startup.get_status_display }}</span>
                  </div>
                  <div class="startup-detail-row">
                      <span class="detail-label">Собранная сумма:</span>
                      <span class="detail-value">{{ investment.startup.current_investment }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                      <span class="detail-label">Цель финансирования:</span>
                      <span class="detail-value">{{ investment.startup.goal }} ₽</span>
                  </div>
                   <div class="startup-category-tag">{{ investment.startup.category.name }}</div>
              </div>
            </div>
          {% empty %}
             <p>У вас пока нет инвестиций.</p>
          {% endfor %}
          {% endcomment %}

        </div>

        <button class="show-more-btn" id="load-more">
          Показать еще <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('startup-search');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.startup-card').forEach(card => {
              const name = card.getAttribute('data-name').toLowerCase();
              if (name.includes(searchTerm)) {
                card.style.display = 'flex';
              } else {
                card.style.display = 'none';
              }
            });
          });
        }
        
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.startup-card');
            
            if (filter === 'all') {
              cards.forEach(card => card.style.display = 'flex');
            } else if (filter === 'category') {
              alert('Выберите категорию для фильтрации');
            } else if (filter === 'new') {
            }
          });
        });
        
        const loadMoreBtn = document.getElementById('load-more');
        const startupCards = document.querySelectorAll('.startup-card');
        
        if (loadMoreBtn && startupCards.length > 6) {
          for (let i = 6; i < startupCards.length; i++) {
            startupCards[i].style.display = 'none';
          }
          
          loadMoreBtn.addEventListener('click', function() {
            startupCards.forEach(card => card.style.display = 'flex');
            this.style.display = 'none';
          });
        }
      });
    </script>
  {% else %}
    <div class="access-restricted">
      <h2>Доступ ограничен</h2>
      <p>Эта страница доступна только для пользователей со статусом "Инвестор". Пожалуйста, войдите в аккаунт или зарегистрируйтесь как инвестор.</p>
      {% if user.is_authenticated %}
        <p>Ваша текущая роль: {{ user.role.role_name|default:"не указана" }}</p>
        <p>Чтобы изменить роль, перейдите в настройки профиля.</p>
        <a href="{% url 'profile' %}" class="access-button">Перейти в профиль</a>
      {% else %}
        <a href="{% url 'login' %}" class="access-button">Войти</a>
        <a href="{% url 'register' %}" class="access-button" style="margin-left: 10px;">Зарегистрироваться</a>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}