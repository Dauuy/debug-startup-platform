{% extends 'accounts/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Портфель{% endblock %}

{% block head_extra %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'accounts/css/investments_styles.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  {% if user.is_authenticated and user.role.role_name == 'investor' %}
    <div class="portfolio-container">
      <!-- Верхняя секция с аналитикой -->
      <div class="analytics-section">
        <div class="analytics-left">
          <div class="portfolio-image-container">
            <button class="portfolio-image-fullscreen-btn">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <!-- Категории с радиальными диаграммами -->
          <div class="categories-radial-section">
            <h3 class="categories-radial-title">Категории</h3>
            <div class="categories-radial-grid">
              {% for category in investment_categories %}
              <div class="category-radial-item">
                <div class="radial-chart" data-percentage="{{ category.percentage }}">
                  <div class="radial-chart-progress"></div>
                  <div class="radial-chart-text">{{ category.percentage }}%</div>
                </div>
                <span class="category-radial-name">
                    {% with original_name=category.name|default:"" %}
                        {% if original_name == "Medicine" %}Медицина
                        {% elif original_name == "Auto" %}Автомобили
                        {% elif original_name == "Delivery" %}Доставка
                        {% elif original_name == "Cafe" %}Кафе/рестораны
                        {% elif original_name == "Fastfood" %}Фастфуд
                        {% elif original_name == "Health" %}Здоровье
                        {% elif original_name == "Beauty" %}Красота
                        {% elif original_name == "Transport" %}Транспорт
                        {% elif original_name == "Sport" %}Спорт
                        {% elif original_name == "Psychology" %}Психология
                        {% elif original_name == "AI" %}ИИ
                        {% elif original_name == "Finance" %}Финансы
                        {% elif original_name == "Healthcare" %}Здравоохранение
                        {% elif original_name == "Technology" %}Технологии
                        {% elif original_name == "IT" %}ИТ {# Добавляем перевод для IT #}
                        {% else %}{{ original_name|default:"Не указано" }}
                        {% endif %}
                    {% endwith %}
                </span>
              </div>
              {% empty %}
                <div class="category-radial-item">
                    <div class="radial-chart" data-percentage="70">
                        <div class="radial-chart-progress"></div>
                        <div class="radial-chart-text">70%</div>
                    </div>
                    <span class="category-radial-name">Медицина</span>
                </div>
                <div class="category-radial-item">
                    <div class="radial-chart" data-percentage="90">
                        <div class="radial-chart-progress"></div>
                        <div class="radial-chart-text">90%</div>
                    </div>
                    <span class="category-radial-name">ИТ</span>
                </div>
                <div class="category-radial-item">
                    <div class="radial-chart" data-percentage="60">
                        <div class="radial-chart-progress"></div>
                        <div class="radial-chart-text">60%</div>
                    </div>
                    <span class="category-radial-name">Финансы</span>
                </div>
                 <div class="category-radial-item">
                    <div class="radial-chart" data-percentage="40">
                        <div class="radial-chart-progress"></div>
                        <div class="radial-chart-text">40%</div>
                    </div>
                    <span class="category-radial-name">Ритейл</span>
                 </div>
                 <p>Нет данных по категориям.</p>
              {% endfor %}
              <!-- Категория "Все" -->
              <div class="category-radial-item category-all" id="openCategoriesModalBtn">
                <div class="radial-chart-all">
                   <i class="fas fa-ellipsis-h"></i>
                </div>
                <span class="category-radial-name">Все</span>
              </div>
            </div>
          </div>
        </div>
        <div class="analytics-content">
          <div class="analytics-header">
              <h1 class="analytics-title">Аналитика</h1>
              <div class="analytics-controls">
                  <select class="month-select">
                      <option value="март">Март</option>
                      <option value="апрель">Апрель</option>
                      <option value="май">Май</option>
                      {# Другие месяцы #}
                  </select>
                  <button class="analytics-options-btn">
                      <i class="fas fa-ellipsis-v"></i>
                  </button>
              </div>
          </div>

          <div class="stats-overview">
            <div class="stat-item">
              <span class="stat-label">Кол-во стартапов</span>
              <div class="stat-value-box dark-box">{{ startups_count|default:"12" }}</div>
            </div>
            <div class="stat-item">
              <span class="stat-label">Общая сумма инвестирования</span>
              <div class="stat-value-box blue-box">{{ total_investment|default:"0"|intcomma }} ₽</div>
            </div>
          </div>

          <div class="stats-details">
             <div class="stat-item detail-item">
              <span class="stat-label">Макс. сумма инвестирования</span>
              <span class="stat-value-simple">{{ max_investment|default:"0"|intcomma }} ₽</span>
            </div>
            <div class="stat-item detail-item">
              <span class="stat-label">Мин. сумма инвестирования</span>
              <span class="stat-value-simple">{{ min_investment|default:"0"|intcomma }} ₽</span>
            </div>
          </div>

          <!-- График -->
          <div class="analytics-chart-container">
            <canvas id="monthlyInvestmentChart"></canvas>
            <span class="chart-title-overlay">Аналитика этого месяца</span>

          </div>

          <button class="download-report-btn">Скачать отчет</button>
        </div>
      </div>
      
      <!-- Раздел Мои стартапы -->
      <div class="my-startups-section">
        <div class="startups-header">
          <div class="startups-titles">
            <h2 class="startups-title-main">МОИ</h2>
            <h2 class="startups-title-sub">СТАРТАПЫ</h2>
          </div>
          <div class="total-investment">
            <span class="investment-label">инвестировано</span>
            <div class="investment-amount">{{ total_investment|default:"0"|intcomma }}</div>
          </div>
        </div>

        <div class="startups-filters">
          <div class="startups-search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" placeholder="Поиск" id="startup-search" class="startups-search-input">
          </div>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">Все</button>
            <div class="filter-dropdown-wrapper">
              <button class="filter-btn filter-btn-dropdown" data-filter="category">Категория <i class="fas fa-chevron-down"></i></button>
              {# Здесь может быть выпадающий список категорий #}
              <div class="filter-dropdown-content">
                <a href="#" data-category="medicine">Медицина</a>
                <a href="#" data-category="it">IT</a>
                <a href="#" data-category="finance">Финансы</a>
                {# Другие категории #}
              </div>
            </div>
            <button class="filter-btn" data-filter="new"><i class="fas fa-sort-amount-up"></i> Новые</button>
          </div>
        </div>

        <div class="startups-grid">
          {% for investment in user_investments %}
            <div class="startup-card" data-category="{{ investment.startup.category.name }}" data-name="{{ investment.startup.name }}">
              <div class="startup-card-left">
                   <img src="{{ investment.startup.planet_image.url | default:'/static/accounts/images/planets/startup_5_logo.png' }}" alt="{{ investment.startup.name }} Planet" class="startup-planet-img">
                  <div class="startup-name">{{ investment.startup.name }}</div>
                  <div class="startup-rating">
                      <i class="fas fa-star"></i>
                      <i class="fas fa-star"></i>
                      <i class="fas fa-star"></i>
                      <i class="fas fa-star"></i>
                      <i class="fas fa-star-half-alt"></i>
                  </div>
                  <button class="startup-chat-btn"><i class="fas fa-comment-dots"></i></button>
              </div>
              <div class="startup-card-right">
                  <div class="startup-detail-row">
                      <span class="detail-label">Статус</span>
                      <span class="detail-value status-{{ investment.startup.get_status_display|lower|default:'активен' }}">{{ investment.startup.get_status_display|default:'Активен' }}</span>
                  </div>
                  <div class="startup-detail-row">
                      <span class="detail-label">Собранная сумма:</span>
                      <span class="detail-value">{{ investment.startup.current_investment|default:'0'|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                      <span class="detail-label">Ваши инвестиции:</span>
                      <span class="detail-value">{{ investment.amount|floatformat:0|intcomma }} ₽</span>
                  </div>
                  <div class="startup-detail-row">
                      <span class="detail-label">Цель финансирования:</span>
                      <span class="detail-value">{{ investment.startup.goal|default:'0'|intcomma }} ₽</span>
                  </div>
                   <div class="startup-category-tag">{{ investment.startup.category.name|default:'Категория' }}</div>
              </div>
            </div>
          {% empty %}
             <p>У вас пока нет инвестиций.</p>
          {% endfor %}
        </div>

        <button class="show-more-btn" id="load-more">
          Показать еще <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>
    
    <!-- ==== Модальное окно для всех категорий (HTML остается, но JS будет заполнять grid) ==== -->
    <div id="allCategoriesModal" class="modal-overlay">
        <div class="modal-content category-modal-content">
            <button class="modal-close-btn" id="closeCategoriesModalBtn">&times;</button>
            <h2 class="modal-title">Все категории инвестиций</h2>
            <div class="modal-categories-grid" id="modalCategoriesGrid"> {# Добавляем ID для JS #}
                {# Содержимое будет генерироваться JS #}
            </div>
        </div>
    </div>
    <!-- ==== Конец модального окна ==== -->
    
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('startup-search');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            document.querySelectorAll('.startup-card').forEach(card => {
              const name = card.getAttribute('data-name').toLowerCase();
              if (name.includes(searchTerm)) {
                card.style.display = 'flex';
              } else {
                card.style.display = 'none';
              }
            });
          });
        }
        
        const filterButtons = document.querySelectorAll('.filter-btn');
        filterButtons.forEach(button => {
          button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.getAttribute('data-filter');
            const cards = document.querySelectorAll('.startup-card');
            
            if (filter === 'all') {
              cards.forEach(card => card.style.display = 'flex');
            } else if (filter === 'category') {
              alert('Выберите категорию для фильтрации');
            } else if (filter === 'new') {
            }
          });
        });
        
        const loadMoreBtn = document.getElementById('load-more');
        const startupCards = document.querySelectorAll('.startups-grid .startup-card');
        const initialVisibleCount = 6;

        if (loadMoreBtn && startupCards.length > initialVisibleCount) {
          for (let i = initialVisibleCount; i < startupCards.length; i++) {
            if (startupCards[i]) {
              startupCards[i].style.display = 'none';
            }
          }

          loadMoreBtn.addEventListener('click', function() {
            startupCards.forEach(card => {
              if (card) {
                  card.style.display = 'flex';
              }
            });
            this.style.display = 'none';
          });
        } else if (loadMoreBtn) {
            loadMoreBtn.style.display = 'none';
        }

        // <<< Скрипт для инициализации графика >>>
        (function() { // Используем IIFE для изоляции области видимости
            const canvasElement = document.getElementById('monthlyInvestmentChart');
            if (!canvasElement) {
                console.error("Элемент canvas #monthlyInvestmentChart не найден.");
                return;
            }
            const ctx = canvasElement.getContext('2d');
            
            // Получаем данные из встроенных JSON скриптов
            let monthLabels = [];
            let monthData = [];
            try {
                monthLabels = JSON.parse(document.getElementById('chart-month-labels').textContent);
                monthData = JSON.parse(document.getElementById('chart-month-data').textContent);
            } catch (e) {
                console.error("Ошибка парсинга данных для графика:", e);
                canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: red;">Ошибка загрузки данных для графика.</p>';
                return;
            }

            // Проверяем, есть ли данные для графика
            const hasData = monthData && monthData.some(value => value > 0);

            if (hasData) {
                // Создаем градиент для фона столбцов
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 123, 255, 0.8)'); // Синий сверху
                gradient.addColorStop(1, 'rgba(0, 123, 255, 0.1)'); // Прозрачный синий снизу

                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthLabels,
                        datasets: [{
                            label: 'Сумма инвестиций',
                            data: monthData,
                            backgroundColor: gradient, // Применяем градиент
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                            borderRadius: 5, // Небольшое скругление углов столбцов
                            barThickness: 'flex', // Автоматическая ширина столбцов
                            maxBarThickness: 30 // Максимальная ширина столбца
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)' // Цвет сетки оси Y
                                },
                                ticks: {
                                    // Форматирование чисел на оси Y
                                    callback: function(value, index, values) {
                                        if (value >= 1000) {
                                            return (value / 1000).toLocaleString('ru-RU') + 'k';
                                        } else {
                                            return value.toLocaleString('ru-RU');
                                        }
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false // Убираем сетку оси X
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Скрываем легенду
                            },
                            tooltip: {
                                // Кастомизация всплывающих подсказок
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            // Форматируем сумму с пробелами и знаком рубля
                                            label += context.parsed.y.toLocaleString('ru-RU', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' ₽';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Если данных нет, показываем сообщение
                canvasElement.parentNode.innerHTML = '<p style="text-align: center; color: #6c757d;">Нет данных для графика за текущий год.</p>';
            }
        })(); // Вызываем IIFE
        // <<< Конец скрипта для графика >>>

        // ==== Логика для модального окна категорий ==== 
        (function() {
          const openBtn = document.getElementById('openCategoriesModalBtn');
          const closeBtn = document.getElementById('closeCategoriesModalBtn');
          const modalOverlay = document.getElementById('allCategoriesModal');
          const modalGrid = document.getElementById('modalCategoriesGrid');
          
          // Данные из Django (безопасно парсим)
          let allDirections = [];
          let investedData = {};
          try {
              const allDirectionsElement = document.getElementById('all-directions-data');
              const investedDataElement = document.getElementById('invested-category-data');

              if (!allDirectionsElement || !investedDataElement) {
                  throw new Error("Не найдены элементы данных для модального окна.");
              }

              const allDirectionsRaw = allDirectionsElement.textContent;
              const investedDataRaw = investedDataElement.textContent;
              
              console.log("Raw allDirectionsData:", allDirectionsRaw); // Отладка
              console.log("Raw investedData:", investedDataRaw); // Отладка
              
              const parsedDirections = JSON.parse(allDirectionsRaw);
              console.log("Parsed allDirectionsData:", parsedDirections, "Is Array?", Array.isArray(parsedDirections)); // Отладка
              
              if (!Array.isArray(parsedDirections)) {
                   throw new TypeError("Данные категорий не являются массивом.");
              }

              allDirections = parsedDirections.map(item => ({
                  pk: item.pk,
                  name: item.direction_name
              }));
              investedData = JSON.parse(investedDataRaw);

          } catch (e) {
              console.error("Ошибка парсинга данных для модального окна категорий:", e);
          }

          // Функция для перевода названий категорий
          function translateCategoryName(name) {
              const translations = {
                  "Medicine": "Медицина",
                  "Auto": "Автомобили",
                  "Delivery": "Доставка",
                  "Cafe": "Кафе/рестораны",
                  "Fastfood": "Фастфуд",
                  "Health": "Здоровье",
                  "Beauty": "Красота",
                  "Transport": "Транспорт",
                  "Sport": "Спорт",
                  "Psychology": "Психология",
                  "AI": "ИИ",
                  "Finance": "Финансы",
                  "Healthcare": "Здравоохранение",
                  "Technology": "Технологии",
                  "IT": "ИТ"
                  // Добавьте другие переводы, если нужно
              };
              return translations[name] || name || "Не указано"; // Возвращаем перевод или оригинал
          }

          function openModal() {
            if (!modalOverlay || !modalGrid) return;
            
            // Очищаем и заполняем сетку категорий
            modalGrid.innerHTML = ''; // Очищаем предыдущее содержимое
            if (allDirections.length > 0) {
                allDirections.forEach(direction => {
                    const percentage = investedData[direction.name] || 0;
                    const translatedName = translateCategoryName(direction.name); // Используем перевод
                    const color = getColorForPercentage(percentage); // Получаем цвет
                    
                    const item = document.createElement('div');
                    item.classList.add('modal-category-item');
                    
                    // Генерируем HTML для радиальной диаграммы и имени
                    item.innerHTML = `
                        <div class="radial-chart" data-percentage="${percentage}">
                          <div class="radial-chart-progress" style="--percentage: ${percentage}; --progress-color: ${color};"></div>
                          <div class="radial-chart-text">${percentage}%</div>
                        </div>
                        <span class="modal-category-name">${translatedName}</span>
                    `;
                    
                    modalGrid.appendChild(item);
                });
            } else {
                modalGrid.innerHTML = '<p>Нет доступных категорий.</p>';
            }

            modalOverlay.classList.add('visible');
            document.body.classList.add('modal-open-blur');
          }

          function closeModal() {
            if (!modalOverlay) return;
            modalOverlay.classList.remove('visible');
            document.body.classList.remove('modal-open-blur');
          }

          if (openBtn) {
            openBtn.addEventListener('click', openModal);
          }

          if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
          }

          // Закрытие по клику на фон
          if (modalOverlay) {
              modalOverlay.addEventListener('click', function(event) {
                  if (event.target === modalOverlay) { // Клик именно по фону, а не по контенту
                      closeModal();
                  }
              });
          }
        })();
        // ==== Конец логики модального окна ==== 
      });

      // Функция для определения цвета по проценту
      function getColorForPercentage(percentage) {
        if (percentage >= 75) {
          return '#28a745'; // Зеленый
        } else if (percentage >= 50) {
          return '#007bff'; // Синий
        } else if (percentage >= 25) {
          return '#ffc107'; // Желтый
        } else if (percentage > 0) {
          return '#dc3545'; // Красный
        } else {
          return '#6c757d'; // Серый для 0%
        }
      }

      // Функция для обновления цветов радиальных диаграмм
      function updateRadialChartColors() {
        document.querySelectorAll('.radial-chart').forEach(chart => {
          const percentage = parseInt(chart.dataset.percentage || 0, 10);
          const color = getColorForPercentage(percentage);
          const progressElement = chart.querySelector('.radial-chart-progress');
          if (progressElement) {
              // Устанавливаем CSS переменные для градиента
              progressElement.style.setProperty('--percentage', percentage);
              progressElement.style.setProperty('--progress-color', color);
          }
          // Опционально: изменить цвет текста в зависимости от фона?
          // const textElement = chart.querySelector('.radial-chart-text');
          // if (textElement) { textElement.style.color = ...; }
        });
      }

      // Вызываем обновление цветов при загрузке DOM
      document.addEventListener('DOMContentLoaded', updateRadialChartColors);

      // Добавляем обработчик для кнопки открытия модального окна
      document.getElementById('addCategoryBtn').addEventListener('click', openModal);
    </script>
  {% else %}
    <div class="access-restricted">
      <h2>Доступ ограничен</h2>
      <p>Эта страница доступна только для пользователей со статусом "Инвестор". Пожалуйста, войдите в аккаунт или зарегистрируйтесь как инвестор.</p>
      {% if user.is_authenticated %}
        <p>Ваша текущая роль: {{ user.role.role_name|default:"не указана" }}</p>
        <p>Чтобы изменить роль, перейдите в настройки профиля.</p>
        <a href="{% url 'profile' %}" class="access-button">Перейти в профиль</a>
      {% else %}
        <a href="{% url 'login' %}" class="access-button">Войти</a>
        <a href="{% url 'register' %}" class="access-button" style="margin-left: 10px;">Зарегистрироваться</a>
      {% endif %}
    </div>
  {% endif %}

  {# <<< Переносим json_script сюда, внутрь блока content >>> #}
  {{ month_labels|json_script:"chart-month-labels" }}
  {{ month_data|json_script:"chart-month-data" }}
  {# Восстанавливаем json_script для all_directions #}
  {{ all_directions|json_script:"all-directions-data" }}
  {{ invested_category_data|json_script:"invested-category-data" }}

{% endblock %}

<script>
// ... JS из блока content переехал сюда ...
</script>