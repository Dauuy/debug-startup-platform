{% extends 'accounts/base.html' %}
{% load static %}
{% load file_tags %}

{% block title %}Каталог стартапов{% endblock %}

{% block head_extra %}
  {{ block.super }}
  {# <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}"> <-- Закомментируем или удалим, если файла нет #}
  <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  {# <<< Восстанавливаем noUiSlider CSS >>> #}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
  {# <<< Комментируем rangeslider.js CSS >>> #}
  {# <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.3.0/rangeslider.min.css"> #}
  {# JS пока не подключаем здесь #}
  {# <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script> #}
  {# <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script> #}
{% endblock %}

{% block content %}
<div class="catalog-wrapper">
  <div class="catalog-container">
    <!-- Боковая панель с фильтрами -->
    <div class="sidebar">
      <form method="get" id="filterForm">
        <div class="sort-dropdown">
          <h2 class="categories-title">Показать сначала</h2>
          <select name="sort_order" id="sortOrder">
            <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Новые</option>
            <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Старые</option>
          </select>
        </div>
        
        <h2 class="categories-title">Категории</h2>
        
        <ul class="categories-list">
          {% for dir in directions %}
            <li class="category-item">
              <label class="category-label">
                <input type="checkbox" name="category" value="{{ dir.direction_name }}" class="category-checkbox" {% if dir.direction_name in selected_categories %}checked{% endif %}>
                <span class="category-name">
                    {% with original_name=dir.direction_name|default:"" %}
                        {% if original_name == "Medicine" %}Медицина
                        {% elif original_name == "Auto" %}Автомобили
                        {% elif original_name == "Delivery" %}Доставка
                        {% elif original_name == "Cafe" %}Кафе/рестораны
                        {% elif original_name == "Fastfood" %}Фастфуд
                        {% elif original_name == "Health" %}Здоровье
                        {% elif original_name == "Beauty" %}Красота
                        {% elif original_name == "Transport" %}Транспорт
                        {% elif original_name == "Sport" %}Спорт
                        {% elif original_name == "Psychology" %}Психология
                        {% elif original_name == "AI" %}ИИ
                        {% elif original_name == "Finance" %}Финансы
                        {% elif original_name == "Healthcare" %}Здравоохранение
                        {% elif original_name == "Technology" %}Технологии
                        {% else %}{{ original_name|default:"Не указано" }}{# Возвращаем оригинал или "Не указано" #}
                        {% endif %}
                    {% endwith %}
                </span>
              </label>
            </li>
          {% empty %}
            <li>Категории не найдены.</li>
          {% endfor %}
        </ul>
        
        <!-- Фильтр рейтинга -->
        <div class="rating-filter">
          {# <<< Восстанавливаем разметку для noUiSlider >>> #}
          <label class="rating-label">Рейтинг: <span id="ratingRangeValues">{{ min_rating|default:0|floatformat:1 }} - {{ max_rating|default:5|floatformat:1 }}</span></label>
          <div id="ratingSlider"></div> {# <<< Контейнер для noUiSlider >>> #}
          {# <<< Восстанавливаем скрытые поля >>> #}
          <input type="hidden" name="min_rating" id="minRatingInput" value="{{ min_rating|default:0|floatformat:1 }}">
          <input type="hidden" name="max_rating" id="maxRatingInput" value="{{ max_rating|default:5|floatformat:1 }}">
        </div>
        
        <!-- Микроинвестиции -->
        <div class="micro-investment">
          <div class="micro-investment-label-wrapper">
            <span class="micro-label">Микроинвестиции</span>
            <span class="help-icon">?</span>
          </div>
          <div class="toggle-switch {% if micro_investment %}active{% endif %}" id="microToggle" onclick="toggleMicroInvestment()">
            <div class="toggle-handle"></div>
          </div>
          <input type="hidden" name="micro_investment" id="microInvestmentInput" value="{% if micro_investment %}1{% else %}0{% endif %}">
        </div>
        
        <input type="hidden" name="search" value="{{ search_query|default_if_none:'' }}">
        
        <!-- Кнопка показать -->
        <button type="submit" class="show-button">Показать</button>
      </form>
    </div>
    
    <!-- Область с карточками стартапов и поиском -->
    <div class="startups-content">
      <!-- Поисковая строка -->
      <div class="catalog-search-wrapper">
        <div class="catalog-search">
          <input type="text" class="catalog-search-input" placeholder="Поиск по каталогу" value="{{ search_query|default_if_none:'' }}">
          <button class="catalog-search-btn"><i class="fas fa-search"></i></button>
        </div>
      </div>
      
      <!-- Сетка стартапов -->
      <div class="startups-grid">
        {# Возвращаем approved_startups #}
        {% if approved_startups %}
          {% for startup in approved_startups %}
            {# Возвращаем условие if forloop.counter <= 6 #}
            {% if forloop.counter <= 6 %}
              {# <<< Изменено: Убираем обертку <a> >>> #}
              {# <a href="{% url 'startup_detail' startup.startup_id %}" class="startup-card-link"> #}
                <div class="startup-card">
                  <span class="startup-franchise-tag">Франшиза</span>
                  <div class="startup-card-inner">
                    <div class="startup-image">
                      {% if startup.logo_urls %}
                        <img src="{% get_file_url_tag startup.logo_urls.0 startup.startup_id 'logo' %}" alt="{{ startup.title }}">
                      {% else %}
                        <div class="startup-image-placeholder">
                          {{ startup.title|make_list|first|upper }}
                        </div>
                      {% endif %}
                    </div>
                    
                    <h3 class="startup-name">{{ startup.title }}</h3>
                    
                    <div class="startup-rating-comments">
                      <span class="rating-text">Рейтинг {{ startup.average_rating|floatformat:1 }}/5 ({{ startup.total_voters }})</span>
                      <span class="comments-count">
                        <i class="far fa-comment"></i>
                        {{ startup.comments.count|default:0 }}
                      </span>
                    </div>
                    
                    <div class="category-progress">
                      <div class="category-tag">
                        {% with original_name=startup.direction.direction_name|default:"" %}
                            {% if original_name == "Medicine" %}Медицина
                            {% elif original_name == "Auto" %}Автомобили
                            {% elif original_name == "Delivery" %}Доставка
                            {% elif original_name == "Cafe" %}Кафе/рестораны
                            {% elif original_name == "Fastfood" %}Фастфуд
                            {% elif original_name == "Health" %}Здоровье
                            {% elif original_name == "Beauty" %}Красота
                            {% elif original_name == "Transport" %}Транспорт
                            {% elif original_name == "Sport" %}Спорт
                            {% elif original_name == "Psychology" %}Психология
                            {% elif original_name == "AI" %}ИИ
                            {% elif original_name == "Finance" %}Финансы
                            {% elif original_name == "Healthcare" %}Здравоохранение
                            {% elif original_name == "Technology" %}Технологии
                            {% else %}{{ original_name|default:"Не указано" }}{# Возвращаем оригинал или "Не указано" #}
                            {% endif %}
                        {% endwith %}
                      </div>
                      {% with progress=startup.get_progress_percentage|default:0 %}
                      <div class="progress-bar-container">
                        <div class="progress-bar-bg">
                          <div class="progress-bar-fill" style="width: {{ progress }}%;"></div>
                        </div>
                        <span class="progress-percentage">{{ progress|floatformat:0 }}%</span>
                      </div>
                      {% endwith %}
                    </div>
                    
                    <div class="investment-type">
                      {% if startup.both_mode %}Инвестирование+Выкуп{% elif startup.only_invest %}Только инвестирование{% elif startup.only_buy %}Только выкуп{% else %}Тип не указан{% endif %}
                    </div>
                    
                    <div class="funding-goal-info">
                      Цель финансирования: {{ startup.funding_goal|floatformat:"0" }} ₽
                    </div>
                    
                    <div class="investor-count">
                      <i class="fas fa-users"></i>
                      <span>Инвестировало ({{ startup.get_investors_count }})</span>
                    </div>
                    
                    <div class="startup-description">
                      {{ startup.description|truncatewords:15 }}
                    </div>
                    
                    {# <<< Возвращено: Ссылка "Подробнее", но она будет растянута через CSS >>> #}
                    <a href="{% url 'startup_detail' startup.startup_id %}" class="detail-link">
                      {# Текст не нужен, т.к. ссылка будет невидимой #}
                    </a>
                  </div>
                </div>
              {# </a> #}
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="no-startups">
            <p>В настоящее время нет доступных стартапов. Загляните позже!</p>
          </div>
        {% endif %}
      </div>

      {# Возвращаем старую структуру кнопки "Показать еще" #}
      {# {% if initial_has_next %} <-- Убираем это условие #}
        {% if approved_startups|length > 6 %} {# <-- Возвращаем старое условие #}
          <div class="pagination-controls">
            <div class="show-more-container">
                {# Убираем id и data-атрибут #}
                <button class="show-more-btn">
                    Показать еще <i class="fas fa-eye"></i>
                </button>
            </div>
            {# Блок пагинации .pagination удален #}
          </div> {# Конец .pagination-controls #}
        {% endif %}
      {# {% endif %} #}

    </div> {# Конец .startups-content #}
  </div> {# Конец .catalog-container #}
</div> {# Конец .catalog-wrapper #}

{# Удаляем старый скрипт rangeslider #}
{# <script src="https://cdnjs.cloudflare.com/ajax/libs/rangeslider.js/2.3.0/rangeslider.min.js"></script> #}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // <<< Начинаем инициализацию noUiSlider >>>
    var ratingSlider = document.getElementById('ratingSlider');
    var ratingRangeValues = document.getElementById('ratingRangeValues');
    var minRatingInput = document.getElementById('minRatingInput');
    var maxRatingInput = document.getElementById('maxRatingInput');

    // Проверяем, что все элементы существуют и библиотеки подключены
    if (ratingSlider && ratingRangeValues && minRatingInput && maxRatingInput && typeof noUiSlider !== 'undefined' && typeof wNumb !== 'undefined') {
        // Получаем начальные значения из скрытых полей
        var initialMin = parseFloat(minRatingInput.value) || 0;
        var initialMax = parseFloat(maxRatingInput.value) || 5;

        noUiSlider.create(ratingSlider, {
            start: [initialMin, initialMax], // Начальные значения
            connect: true,                 // Соединять ползунки
            range: {
                'min': 0,
                'max': 5
            },
            step: 0.1,                     // Шаг
            format: wNumb({                // Форматирование для отображения
                decimals: 1
            }),
            tooltips: false                 // Отключаем встроенные тултипы
        });

        // Обновляем span и скрытые поля при изменении слайдера
        ratingSlider.noUiSlider.on('update', function (values, handle) {
            // values[0] - значение левого ползунка, values[1] - правого
            var minValue = values[0];
            var maxValue = values[1];

            ratingRangeValues.textContent = minValue + ' - ' + maxValue;
            minRatingInput.value = minValue;
            maxRatingInput.value = maxValue;
        });
    } else {
        console.error('Не удалось инициализировать noUiSlider. Элементы не найдены или библиотеки не подключены.');
        // Выводим, чего не хватает
        if (!ratingSlider) console.error('Элемент #ratingSlider не найден');
        if (!ratingRangeValues) console.error('Элемент #ratingRangeValues не найден');
        if (!minRatingInput) console.error('Элемент #minRatingInput не найден');
        if (!maxRatingInput) console.error('Элемент #maxRatingInput не найден');
        if (typeof noUiSlider === 'undefined') console.error('Библиотека noUiSlider не подключена');
        if (typeof wNumb === 'undefined') console.error('Библиотека wNumb не подключена');
    }
    // <<< Конец инициализации noUiSlider >>>

    // Функция для работы с поиском
    var searchInput = document.querySelector('.catalog-search-input');
    var searchBtn = document.querySelector('.catalog-search-btn');
    
    searchBtn.addEventListener('click', function() {
      var form = document.getElementById('filterForm');
      var searchInputHidden = document.querySelector('input[name="search"]');
      searchInputHidden.value = searchInput.value;
      form.submit();
    });
    
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        var form = document.getElementById('filterForm');
        var searchInputHidden = document.querySelector('input[name="search"]');
        searchInputHidden.value = searchInput.value;
        form.submit();
      }
    });
    
    // Эффект Position Aware для кнопок
    var buttons = document.querySelectorAll('.show-button, .catalog-search-btn, .show-more-btn');
    
    buttons.forEach(function(button) {
      button.addEventListener('mouseenter', function(e) {
        var parentOffset = this.getBoundingClientRect(),
            relX = e.clientX - parentOffset.left,
            relY = e.clientY - parentOffset.top;
        
        var span = document.createElement('span');
        span.style.top = relY + 'px';
        span.style.left = relX + 'px';
        span.classList.add('position-aware-effect');
        
        this.appendChild(span);
        
        setTimeout(function() {
          if (span.parentNode === button) {
            button.removeChild(span);
          }
        }, 600);
      });
    });
    
  });
  
  // Функция для переключения микроинвестиций
  function toggleMicroInvestment() {
    var toggle = document.getElementById('microToggle');
    var input = document.getElementById('microInvestmentInput');
    
    if (toggle.classList.contains('active')) {
      toggle.classList.remove('active');
      input.value = '0';
    } else {
      toggle.classList.add('active');
      input.value = '1';
    }
  }
</script>
{% endblock %}

{% block body_scripts %}
  {{ block.super }} {# На случай, если в base.html уже есть скрипты в этом блоке #}
  {# <<< Подключаем JS noUiSlider и wNumb здесь >>> #}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
{% endblock %}