{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %} {# Убедитесь, что загружен, если используется #}

{% block title %}Каталог стартапов{% endblock %}

{% block head_extra %} {# Подключаем стили только для этой страницы #}
    <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}">
{% endblock %}

{% block content %}
<div class="startups-catalog-page">

    {# Секция поиска и фильтров - Верхняя часть #}
    <div class="filters-header">
        <div class="search-bar-container">
            <input type="text" placeholder="Поиск" class="search-input" name="q" value="{{ request.GET.q|default:'' }}" form="filter-form">
            <button type="submit" class="search-button" form="filter-form">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="black"/> </svg>
            </button>
        </div>
    </div>

    <div class="main-content-area">
        {# Левая колонка - Фильтры #}
        <aside class="filters-sidebar">
            <form method="get" action="{% url 'startups_list' %}" id="filter-form">
                <div class="filter-section">
                    <h4>Категории</h4>
                    <div class="category-filters">
                        {% for direction in all_directions %}
                            <label class="filter-checkbox"> <input type="checkbox" name="category" value="{{ direction.direction_id }}" {% if direction.direction_id|stringformat:"s" in request.GET.getlist.category %}checked{% endif %}> <span class="checkbox-custom"></span> {{ direction.direction_name }} </label>
                        {% empty %}
                            <p>Нет категорий.</p> {# Или покажите статический список #}
                        {% endfor %}
                    </div>
                    <hr class="filter-divider">
                </div>
                <div class="filter-section">
                     <div class="microinvestment-filter">
                        <span>Микроинвестиции</span>
                        <label class="switch"> <input type="checkbox" name="microinvestment" value="true" {% if request.GET.microinvestment == 'true' %}checked{% endif %}> <span class="slider round"></span> </label>
                        <span class="tooltip-icon" title="Включает стартапы, доступные для небольших инвестиций">?</span>
                    </div>
                </div>
                <div class="filter-section">
                    <h4>Рейтинг</h4>
                    <div class="rating-slider">
                        {% with min_r=request.GET.min_rating|default:0 max_r=request.GET.max_rating|default:5.0 %}
                        {% widthratio min_r 5 100 as left_percent %}
                        {# === ИЗМЕНЕНИЕ: Расчет правого отступа через widthratio === #}
                        {# Считаем, сколько НЕ входит в диапазон справа: 5 - max_r #}
                        {# Для этого из 5 вычитаем max_r (используем add с отрицательным числом, но это сложно) #}
                        {# Проще: считаем максимальную позицию и используем calc() в style #}
                        {% widthratio max_r 5 100 as max_pos_percent %}
                        <div class="slider-track"></div>
                        {# Используем left и right для позиционирования диапазона #}
                        <div class="slider-range" style="left: {{ left_percent }}%; right: calc(100% - {{ max_pos_percent }}%);"></div>
                        <div class="slider-thumb" style="left: {{ left_percent }}%;"></div>
                        <div class="slider-thumb" style="left: {{ max_pos_percent }}%;"></div>
                        {# ======================================================== #}
                        <input type="range" min="0" max="5" step="0.1" value="{{ min_r }}" name="min_rating" class="rating-slider-input" id="rating-min" style="display:none;">
                        <input type="range" min="0" max="5" step="0.1" value="{{ max_r }}" name="max_rating" class="rating-slider-input" id="rating-max" style="display:none;">
                        {% endwith %}
                    </div>
                     <div class="rating-inputs">
                        <input type="text" value="{{ request.GET.min_rating|default:0 }}" readonly id="rating-min-display">
                        <input type="text" value="{{ request.GET.max_rating|default:5.0 }}" readonly id="rating-max-display">
                    </div>
                </div>
                 <div class="filter-section">
                     <button type="submit" class="filter-apply-button">Применить</button>
                     <a href="{% url 'startups_list' %}" class="filter-reset-button">Сбросить</a>
                </div>
                {% if request.GET.sort %} <input type="hidden" name="sort" value="{{ request.GET.sort }}"> {% endif %}
            </form>
        </aside>

        {# Правая колонка - Список стартапов #}
        <main class="startup-list-container">
             <form method="get" action="{% url 'startups_list' %}" id="sort-form" class="sort-options">
                {# Скрытые поля для сохранения фильтров #}
                {% for cat_id in request.GET.getlist.category %} <input type="hidden" name="category" value="{{ cat_id }}"> {% endfor %}
                {% if request.GET.microinvestment %} <input type="hidden" name="microinvestment" value="{{ request.GET.microinvestment }}"> {% endif %}
                {% if request.GET.min_rating %} <input type="hidden" name="min_rating" value="{{ request.GET.min_rating }}"> {% endif %}
                {% if request.GET.max_rating %} <input type="hidden" name="max_rating" value="{{ request.GET.max_rating }}"> {% endif %}
                {% if request.GET.q %} <input type="hidden" name="q" value="{{ request.GET.q }}"> {% endif %}

                 <label for="sort-select">Сортировать по:</label>
                 <select id="sort-select" name="sort" class="sort-select-dropdown" onchange="document.getElementById('sort-form').submit();">
                     <option value="newest" {% if request.GET.sort == 'newest' or not request.GET.sort %}selected{% endif %}>Новые</option>
                     <option value="rating_desc" {% if request.GET.sort == 'rating_desc' %}selected{% endif %}>Рейтингу (убыв.)</option>
                     <option value="rating_asc" {% if request.GET.sort == 'rating_asc' %}selected{% endif %}>Рейтингу (возр.)</option>
                 </select>
            </form>

            {% with object_list=startups|default:page_obj.object_list %}
            {% if object_list %}
                <div class="startup-grid">
                    {% for startup in object_list %}
                        <div class="startup-card">
                            <div class="startup-card__image-container">
                                <img src="{% static 'accounts/images/startups/IMG_7665.png' %}" alt="{{ startup.title }} preview" class="startup-card__image">
                            </div>
                            <div class="startup-card__content">
                                <div class="startup-card__header">
                                    <div class="startup-card__title-category">
                                        <h3 class="startup-card__title">{{ startup.title|default:"Без названия" }}</h3>
                                        <p class="startup-card__category">Категория: {{ startup.direction.direction_name|default:"Не указана" }}</p>
                                    </div>
                                    <div class="startup-card__rating">
                                        <p class="startup-card__rating-text">Рейтинг {{ startup.average_rating|default:0.0|floatformat:"1" }}/5</p>
                                        <div class="startup-card__rating-stars">
                                            <div class="stars-outer"><div class="stars-inner" style="width: {% widthratio startup.average_rating|default:0.0 5 100 %}%;"></div></div>
                                        </div>
                                    </div>
                                </div>
                                <p class="startup-card__description"> {{ startup.description|truncatewords_html:25|default:"Описание отсутствует." }} </p>
                                <a href="{% url 'startup_detail' startup.startup_id %}" class="startup-card__button">Подробнее</a>
                                <div class="startup-card__investors">
                                    <span class="investor-icon"> <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.6667 11.3333C10.6667 12.4387 10.016 13.443 9.01393 13.8163C8.01187 14.1896 6.86073 13.8953 6.11493 13.0657C6.03081 12.9637 5.9523 12.8565 5.8801 12.7453C5.33333 13.406 5.33333 14.6667 5.33333 14.6667H2C2 14.6667 2 13.0873 2.90702 11.8786C3.21652 11.4803 3.60532 11.1426 4.05276 10.8833C3.49889 10.4745 3.07145 9.93091 2.81405 9.30695C2.55665 8.68298 2.47979 7.99895 2.59447 7.32814C2.70915 6.65734 3.00978 6.03561 3.46441 5.54079C3.91904 5.04597 4.50746 4.70128 5.15356 4.54672C5.79966 4.39217 6.47636 4.43423 7.10146 4.66732C7.72656 4.90041 8.27208 5.31475 8.67389 5.85768C9.07569 6.40061 9.31713 7.04668 9.37191 7.72162L9.37191 7.72215C9.99086 7.62601 10.6667 8.07668 10.6667 8.75335C10.6667 9.14668 10.448 9.50668 10.1113 9.71201C10.5687 9.93155 10.9259 10.2713 11.1393 10.6887C11.3526 11.106 11.413 11.5809 11.3105 12.0379C11.3105 12.0379 11.3333 11.3333 10.6667 11.3333ZM14 14.6667H12.6667C12.6667 14.6667 12.6667 13.406 12.12 12.7453C12.0478 12.8565 11.9693 12.9637 11.8851 13.0657C11.1393 13.8953 9.98818 14.1896 8.98613 13.8163C7.98407 13.443 7.33333 12.4387 7.33333 11.3333C6.66667 11.3333 6.68953 12.0379 6.68953 12.0379C6.58707 11.5809 6.64747 11.106 6.86081 10.6887C7.07414 10.2713 7.43131 9.93155 7.88867 9.71201C7.552 9.50668 7.33333 9.14668 7.33333 8.75335C7.33333 8.07668 8.00913 7.62601 8.62809 7.72215C8.68287 7.04668 8.92431 6.40061 9.32611 5.85768C9.72792 5.31475 10.2734 4.90041 10.8985 4.66732C11.5236 4.43423 12.2003 4.39217 12.8464 4.54672C13.4925 4.70128 14.081 5.04597 14.5356 5.54079C14.9902 6.03561 15.2908 6.65734 15.4055 7.32814C15.5202 7.99895 15.4433 8.68298 15.1859 9.30695C14.9285 9.93091 14.5011 10.4745 13.9472 10.8833C14.3947 11.1426 14.7835 11.4803 15.093 11.8786C16 13.0873 16 14.6667 16 14.6667H14Z" fill="#4E4F51"/></svg> </span>
                                    Инвестировало ({{ startup.total_voters|default:0 }})
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="no-startups-message">Нет доступных стартапов, соответствующих вашим фильтрам.</p>
            {% endif %}
            {% endwith %}

             {# Пагинация #}
             {% if page_obj.has_other_pages %}
                 <nav class="pagination" aria-label="Page navigation">
                     <ul class="pagination-list">
                         {% if page_obj.has_previous %} <li class="pagination-item"><a href="?page={{ page_obj.previous_page_number }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">« Пред.</a></li>
                         {% else %} <li class="pagination-item disabled"><span class="pagination-link">« Пред.</span></li> {% endif %}
                         {% for i in page_obj.paginator.page_range %}
                             {% if page_obj.number == i %} <li class="pagination-item active"><span class="pagination-link">{{ i }}</span></li>
                             {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %} <li class="pagination-item"><a href="?page={{ i }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">{{ i }}</a></li>
                             {% elif i == 1 and page_obj.number > 3 %} <li class="pagination-item"><a href="?page=1{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">1</a></li> <li class="pagination-item disabled"><span class="pagination-link">...</span></li>
                             {% elif i == page_obj.paginator.num_pages and page_obj.number < page_obj.paginator.num_pages|add:'-2' %} <li class="pagination-item disabled"><span class="pagination-link">...</span></li> <li class="pagination-item"><a href="?page={{ page_obj.paginator.num_pages }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">{{ page_obj.paginator.num_pages }}</a></li>
                             {% endif %}
                         {% endfor %}
                         {% if page_obj.has_next %} <li class="pagination-item"><a href="?page={{ page_obj.next_page_number }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">След. »</a></li>
                         {% else %} <li class="pagination-item disabled"><span class="pagination-link">След. »</span></li> {% endif %}
                     </ul>
                 </nav>
             {% endif %}
        </main>
    </div>
</div>
{% endblock %}