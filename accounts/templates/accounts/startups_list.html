{% extends 'accounts/base.html' %}
{% load static %}
{% load file_tags %}

{% block title %}Каталог стартапов{% endblock %}

{% block head_extra %}
  {{ block.super }}
  {# <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}"> <-- Закомментируем или удалим, если файла нет #}
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Подключаем noUiSlider -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
  <!-- Подключаем wNumb для форматирования -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
  <style>
    /* Стили для каталога стартапов */
    .catalog-wrapper {
      display: flex;
      justify-content: center; /* Центрируем основной контейнер */
      padding: 20px;
    }

    .catalog-container {
      display: flex;
      max-width: 1400px; /* Ограничиваем максимальную ширину */
      width: 100%;
      gap: 30px; /* Отступ между боковой панелью и контентом */
    }

    /* Стили для боковой панели фильтров */
    .sidebar {
      width: 250px; /* Фиксированная ширина сайдбара */
      flex-shrink: 0;
      /* Добавьте другие стили для сайдбара по необходимости */
      background-color: #f8f9fa; /* Пример фона */
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .categories-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #333;
    }

    .categories-list {
        list-style: none;
        padding: 0;
        margin: 0 0 20px 0;
    }

    .category-item {
        margin-bottom: 10px;
    }

    .category-label {
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .category-checkbox {
        margin-right: 8px;
    }

    /* Стили для фильтра рейтинга */
    .rating-filter {
        margin-bottom: 20px;
    }
    .rating-label {
        display: block;
        margin-bottom: 10px;
    }
    .rating-slider {
        /* Стили для слайдера */
    }

    /* Стили для микроинвестиций */
    .micro-investment {
        margin-bottom: 20px;
        /* Стили для переключателя */
    }
    .micro-investment-label-wrapper {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }
    .micro-label {
        margin-right: 5px;
    }
    .help-icon {
        cursor: pointer;
        /* Стили для иконки помощи */
    }
    .toggle-switch {
        /* Стили для самого переключателя */
        width: 50px;
        height: 25px;
        background-color: #ccc;
        border-radius: 15px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .toggle-switch.active {
        background-color: var(--primary-color, #7B61FF);
    }
    .toggle-handle {
        width: 21px;
        height: 21px;
        background-color: white;
        border-radius: 50%;
        position: absolute;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
    }
    .toggle-switch.active .toggle-handle {
        transform: translateX(25px);
    }

    .show-button {
        width: 100%;
        padding: 10px;
        /* Используем переменную или задаем цвет */
        background-color: var(--primary-color, #007bff);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
    }
    
    .show-button:hover {
       opacity: 0.9;
    }

    /* Стили для основного контента (карточки и поиск) */
    .startups-content {
      flex-grow: 1; /* Занимает оставшееся пространство */
      min-width: 0; /* Предотвращает переполнение */
    }

    /* Стили для строки поиска в каталоге */
    .catalog-search-wrapper {
        margin-bottom: 25px; /* Отступ снизу от строки поиска */
        /* width: 1028px; <-- Установим ширину для внутреннего контейнера */
    }

    .catalog-search {
        display: flex;
        align-items: center;
        width: 100%; /* Занимает всю ширину wrapper */
        max-width: 1028px; /* Ограничиваем максимальную ширину */
        height: 42px;
        border: 1px solid #ccc; /* Пример рамки */
        border-radius: 21px; /* Скругление для высоты 42px */
        padding: 0 5px 0 15px; /* Паддинг: слева для текста, справа для кнопки */
        background-color: #fff; /* Фон */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Тень */
        margin: 0 auto; /* Центрируем если wrapper шире */
    }

    .catalog-search-input {
        flex-grow: 1; /* Занимает все доступное место */
        border: none;
        outline: none;
        font-size: 16px;
        background-color: transparent;
        padding-right: 10px; /* Отступ справа от текста до кнопки */
    }

    .catalog-search-btn {
        border: none;
        background-color: transparent;
        color: #555;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 18px; /* Размер иконки */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%; /* Делаем кнопку круглой */
        width: 32px; /* Фиксируем размер кнопки */
        height: 32px;
        flex-shrink: 0;
    }
    
    .catalog-search-btn:hover {
        background-color: #f0f0f0; /* Фон при наведении */
    }

    /* Стили для сетки стартапов */
    .startups-grid {
      display: grid;
      /* Адаптивная сетка */
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px; /* Отступ под сеткой */
    }

    /* Стили для карточки стартапа (скопированы и адаптированы) */
    .startup-card {
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        display: flex;
        flex-direction: column;
    }

    .startup-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .startup-card-inner {
        padding: 15px;
        display: flex;
        flex-direction: column;
        flex-grow: 1; /* Позволяет внутреннему блоку расти */
    }

    .startup-image {
        width: 100%;
        height: 180px; /* Фиксированная высота изображения */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 15px;
        overflow: hidden; /* Обрезаем изображение, если оно больше */
    }

    .startup-image img {
        width: 100%;
        height: 100%;
        object-fit: cover; /* Масштабируем изображение с сохранением пропорций */
    }
    
    .startup-image-placeholder {
        width: 100%;
        height: 100%;
        background-color: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px; /* Крупная буква */
        color: #adb5bd;
        font-weight: bold;
    }

    .startup-name {
        font-size: 18px;
        font-weight: 600;
        margin: 0 0 10px 0;
        color: #333;
    }

    .startup-rating-comments {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #666;
        margin-bottom: 10px;
    }
    .rating-text {
        /* Стили для текста рейтинга */
    }
    .comments-count {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .category-progress {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .category-tag {
        background-color: #f0f0f0;
        color: #555;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
    }
    .progress-bar-container {
        flex-grow: 1;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .progress-bar-bg {
        flex-grow: 1;
        height: 8px;
        background-color: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar-fill {
        height: 100%;
        background-color: var(--primary-color, #007bff);
        border-radius: 4px;
        transition: width 0.5s ease;
    }
    .progress-percentage {
        font-size: 12px;
        color: #555;
        white-space: nowrap;
    }

    .investment-type, .funding-goal-info, .investor-count {
        font-size: 13px;
        color: #666;
        margin-bottom: 8px;
    }
    .investor-count {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .startup-description {
        font-size: 14px;
        color: #444;
        line-height: 1.5;
        margin-bottom: 15px;
        flex-grow: 1; /* Занимает доступное место */
    }

    .detail-link {
        display: inline-flex; /* Используем inline-flex для выравнивания иконки */
        align-items: center; /* Выравниваем иконку по центру */
        gap: 5px; /* Отступ между текстом и иконкой */
        color: var(--primary-color, #007bff);
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        align-self: flex-start; /* Кнопка прижимается к началу */
        margin-top: auto; /* Прижимает кнопку вниз, если описание короткое */
    }
    .detail-link i {
        transition: transform 0.2s ease;
    }
    .detail-link:hover i {
        transform: translateX(3px);
    }

    .no-startups {
        text-align: center;
        padding: 40px;
        color: #777;
        grid-column: 1 / -1; /* Занимает всю ширину грида */
    }
    
    /* Стили для пагинации */
    .pagination-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
    }

    .show-more-container {
        /* Контейнер для кнопки */
    }

    .show-more-btn {
        /* Стили скопированы из buttons.css и адаптированы */
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        overflow: hidden; /* Для эффекта */
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        border: 1px solid var(--primary-color, #007bff); /* Пример */
        background-color: var(--primary-color, #007bff);
        color: white;
    }

    .show-more-btn i {
        margin-left: 8px;
    }

    .show-more-btn:hover {
        background-color: darken(var(--primary-color, #007bff), 10%);
        border-color: darken(var(--primary-color, #007bff), 10%);
    }

    /* Эффект Position Aware для кнопки "Показать еще" (если используется JS) */
    .show-more-btn .position-aware-effect {
      position: absolute;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.3);
      transform: scale(0);
      animation: ripple 0.6s linear;
      pointer-events: none;
    }

    @keyframes ripple {
      to {
        transform: scale(4);
        opacity: 0;
      }
    }

  </style>
{% endblock %}

{% block content %}
<div class="catalog-wrapper">
  <div class="catalog-container">
    <!-- Боковая панель с фильтрами -->
    <div class="sidebar">
      <form method="get" id="filterForm">
        <div class="sort-dropdown">
          <h2 class="categories-title">Показать сначала</h2>
          <select name="sort_order" id="sortOrder">
            <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Новые</option>
            <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Старые</option>
          </select>
        </div>
        
        <h2 class="categories-title">Категории</h2>
        
        <ul class="categories-list">
          {% for dir in directions %}
            <li class="category-item">
              <label class="category-label">
                <input type="checkbox" name="category" value="{{ dir.direction_name }}" class="category-checkbox" {% if dir.direction_name in selected_categories %}checked{% endif %}>
                <span class="category-name">
                    {% with original_name=dir.direction_name|default:"" %}
                        {% if original_name == "Medicine" %}Медицина
                        {% elif original_name == "Auto" %}Автомобили
                        {% elif original_name == "Delivery" %}Доставка
                        {% elif original_name == "Cafe" %}Кафе/рестораны
                        {% elif original_name == "Fastfood" %}Фастфуд
                        {% elif original_name == "Health" %}Здоровье
                        {% elif original_name == "Beauty" %}Красота
                        {% elif original_name == "Transport" %}Транспорт
                        {% elif original_name == "Sport" %}Спорт
                        {% elif original_name == "Psychology" %}Психология
                        {% elif original_name == "AI" %}ИИ
                        {% elif original_name == "Finance" %}Финансы
                        {% elif original_name == "Healthcare" %}Здравоохранение
                        {% elif original_name == "Technology" %}Технологии
                        {% else %}{{ original_name|default:"Не указано" }}{# Возвращаем оригинал или "Не указано" #}
                        {% endif %}
                    {% endwith %}
                </span>
              </label>
            </li>
          {% empty %}
            <li>Категории не найдены.</li>
          {% endfor %}
        </ul>
        
        <!-- Фильтр рейтинга -->
        <div class="rating-filter">
          <label class="rating-label">Рейтинг: <span id="ratingRangeValues">{{ min_rating|floatformat:1 }} - {{ max_rating|floatformat:1 }}</span></label>
          <div id="ratingRange" class="rating-slider"></div>
          <input type="hidden" name="min_rating" id="minRatingInput" value="{{ min_rating|floatformat:1 }}">
          <input type="hidden" name="max_rating" id="maxRatingInput" value="{{ max_rating|floatformat:1 }}">
        </div>
        
        <!-- Микроинвестиции -->
        <div class="micro-investment">
          <div class="micro-investment-label-wrapper">
            <span class="micro-label">Микроинвестиции</span>
            <span class="help-icon">?</span>
          </div>
          <div class="toggle-switch {% if micro_investment %}active{% endif %}" id="microToggle" onclick="toggleMicroInvestment()">
            <div class="toggle-handle"></div>
          </div>
          <input type="hidden" name="micro_investment" id="microInvestmentInput" value="{% if micro_investment %}1{% else %}0{% endif %}">
        </div>
        
        <input type="hidden" name="search" value="{{ search_query|default_if_none:'' }}">
        
        <!-- Кнопка показать -->
        <button type="submit" class="show-button">Показать</button>
      </form>
    </div>
    
    <!-- Область с карточками стартапов и поиском -->
    <div class="startups-content">
      <!-- Поисковая строка -->
      <div class="catalog-search-wrapper">
        <div class="catalog-search">
          <input type="text" class="catalog-search-input" placeholder="Поиск по каталогу" value="{{ search_query|default_if_none:'' }}">
          <button class="catalog-search-btn"><i class="fas fa-search"></i></button>
        </div>
      </div>
      
      <!-- Сетка стартапов -->
      <div class="startups-grid">
        {# Возвращаем approved_startups #}
        {% if approved_startups %}
          {% for startup in approved_startups %}
            {# Возвращаем условие if forloop.counter <= 6 #}
            {% if forloop.counter <= 6 %}
              <div class="startup-card">
                <div class="startup-card-inner">
                  <div class="startup-image">
                    {% if startup.logo_urls %}
                      <img src="{% get_file_url_tag startup.logo_urls.0 startup.startup_id 'logo' %}" alt="{{ startup.title }}">
                    {% else %}
                      <div class="startup-image-placeholder">
                        {{ startup.title|make_list|first|upper }}
                      </div>
                    {% endif %}
                  </div>
                  
                  <h3 class="startup-name">{{ startup.title }}</h3>
                  
                  <div class="startup-rating-comments">
                    <span class="rating-text">Рейтинг {{ startup.average_rating|floatformat:1 }}/5 ({{ startup.total_voters }})</span>
                    <span class="comments-count">
                      <i class="far fa-comment"></i>
                      {# Пока нет данных для количества комментариев #}
                      {# {{ comment_count }} #} 
                      -- 
                    </span>
                  </div>
                  
                  <div class="category-progress">
                    <div class="category-tag">
                      {% with original_name=startup.direction.direction_name|default:"" %}
                          {% if original_name == "Medicine" %}Медицина
                          {% elif original_name == "Auto" %}Автомобили
                          {% elif original_name == "Delivery" %}Доставка
                          {% elif original_name == "Cafe" %}Кафе/рестораны
                          {% elif original_name == "Fastfood" %}Фастфуд
                          {% elif original_name == "Health" %}Здоровье
                          {% elif original_name == "Beauty" %}Красота
                          {% elif original_name == "Transport" %}Транспорт
                          {% elif original_name == "Sport" %}Спорт
                          {% elif original_name == "Psychology" %}Психология
                          {% elif original_name == "AI" %}ИИ
                          {% elif original_name == "Finance" %}Финансы
                          {% elif original_name == "Healthcare" %}Здравоохранение
                          {% elif original_name == "Technology" %}Технологии
                          {% else %}{{ original_name|default:"Не указано" }}{# Возвращаем оригинал или "Не указано" #}
                          {% endif %}
                      {% endwith %}
                    </div>
                    {% with progress=startup.get_progress_percentage|default:0 %}
                    <div class="progress-bar-container">
                      <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width: {{ progress }}%;"></div>
                      </div>
                      <span class="progress-percentage">{{ progress|floatformat:0 }}%</span>
                    </div>
                    {% endwith %}
                  </div>
                  
                  <div class="investment-type">
                    {% if startup.both_mode %}Инвестирование+Выкуп{% elif startup.only_invest %}Только инвестирование{% elif startup.only_buy %}Только выкуп{% else %}Тип не указан{% endif %}
                  </div>
                  
                  <div class="funding-goal-info">
                    Цель финансирования: {{ startup.funding_goal|floatformat:"0" }} ₽
                  </div>
                  
                  <div class="investor-count">
                    <i class="fas fa-users"></i>
                    <span>Инвестировало ({{ startup.get_investors_count }})</span>
                  </div>
                  
                  <div class="startup-description">
                    {{ startup.description|truncatewords:15 }}
                  </div>
                  
                  <a href="{% url 'startup_detail' startup.startup_id %}" class="detail-link">
                    Подробнее <i class="fas fa-arrow-right"></i>
                  </a>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        {% else %}
          <div class="no-startups">
            <p>В настоящее время нет доступных стартапов. Загляните позже!</p>
          </div>
        {% endif %}
      </div>

      {# Возвращаем старую структуру кнопки "Показать еще" #}
      {# {% if initial_has_next %} <-- Убираем это условие #}
        {% if approved_startups|length > 6 %} {# <-- Возвращаем старое условие #}
          <div class="pagination-controls">
            <div class="show-more-container">
                {# Убираем id и data-атрибут #}
                <button class="show-more-btn">
                    Показать еще <i class="fas fa-eye"></i>
                </button>
            </div>
            {# Блок пагинации .pagination удален #}
          </div> {# Конец .pagination-controls #}
        {% endif %}
      {# {% endif %} #}

    </div> {# Конец .startups-content #}
  </div> {# Конец .catalog-container #}
</div> {# Конец .catalog-wrapper #}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Инициализация noUiSlider
    if (typeof noUiSlider !== 'undefined') {
      var ratingRange = document.getElementById('ratingRange');
      var minRatingInput = document.getElementById('minRatingInput');
      var maxRatingInput = document.getElementById('maxRatingInput');
      var ratingRangeValues = document.getElementById('ratingRangeValues');
      
      // Уничтожаем существующий слайдер, если он есть
      if (ratingRange && ratingRange.noUiSlider) {
        ratingRange.noUiSlider.destroy();
      }
      
      if (ratingRange) { // Проверяем, что элемент существует
          noUiSlider.create(ratingRange, {
            start: [parseFloat(minRatingInput.value || 0), parseFloat(maxRatingInput.value || 5)],
            connect: true,
            range: {
              'min': 0,
              'max': 5
            },
            step: 0.1,
            format: wNumb({
              decimals: 1
            })
          });

          ratingRange.noUiSlider.on('update', function(values, handle) {
            minRatingInput.value = values[0];
            maxRatingInput.value = values[1];
            ratingRangeValues.textContent = values[0] + " - " + values[1];
          });
      } else {
        console.error('Элемент #ratingRange не найден');
      }
    } else {
         console.error('Библиотека noUiSlider не загружена');
    }
    
    // Функция для работы с поиском
    var searchInput = document.querySelector('.catalog-search-input');
    var searchBtn = document.querySelector('.catalog-search-btn');
    
    searchBtn.addEventListener('click', function() {
      var form = document.getElementById('filterForm');
      var searchInputHidden = document.querySelector('input[name="search"]');
      searchInputHidden.value = searchInput.value;
      form.submit();
    });
    
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        var form = document.getElementById('filterForm');
        var searchInputHidden = document.querySelector('input[name="search"]');
        searchInputHidden.value = searchInput.value;
        form.submit();
      }
    });
    
    // Эффект Position Aware для кнопок
    var buttons = document.querySelectorAll('.show-button, .catalog-search-btn, .show-more-btn');
    
    buttons.forEach(function(button) {
      button.addEventListener('mouseenter', function(e) {
        var parentOffset = this.getBoundingClientRect(),
            relX = e.clientX - parentOffset.left,
            relY = e.clientY - parentOffset.top;
        
        var span = document.createElement('span');
        span.style.top = relY + 'px';
        span.style.left = relX + 'px';
        span.classList.add('position-aware-effect');
        
        this.appendChild(span);
        
        setTimeout(function() {
          if (span.parentNode === button) {
            button.removeChild(span);
          }
        }, 600);
      });
    });
    
  });
  
  // Функция для переключения микроинвестиций
  function toggleMicroInvestment() {
    var toggle = document.getElementById('microToggle');
    var input = document.getElementById('microInvestmentInput');
    
    if (toggle.classList.contains('active')) {
      toggle.classList.remove('active');
      input.value = '0';
    } else {
      toggle.classList.add('active');
      input.value = '1';
    }
  }
</script>
{% endblock %}