{% extends 'accounts/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Каталог стартапов{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}">
  <link rel="stylesheet" href="{% static 'accounts/css/startup_form.css' %}">
  <style>
    /* Стили для звезд рейтинга */
    .stars-outer {
      position: relative;
      display: inline-block;
      font-size: 14px;
    }
    .stars-inner {
      position: absolute;
      top: 0;
      left: 0;
      white-space: nowrap;
      overflow: hidden;
      width: 0;
      color: var(--primary-color);
    }
    .stars-outer::before {
      content: "☆☆☆☆☆";
      color: #e0e0e0;
    }
    .stars-inner::before {
      content: "★★★★★";
    }
  </style>
{% endblock %}

{% block content %}
<div class="startups-catalog-page">
  <div class="filters-header">
    <div class="search-bar-container">
      <input type="text" placeholder="Поиск" class="search-input" name="q" value="{{ request.GET.q|default:'' }}" form="filter-form">
      <button type="submit" class="search-button" form="filter-form">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
          <path d="M15.5 14H14.71L14.43 13.73C15.41 12.59 16 11.11 16 9.5C16 5.91 13.09 3 9.5 3C5.91 3 3 5.91 3 9.5C3 13.09 5.91 16 9.5 16C11.11 16 12.59 15.41 13.73 14.43L14 14.71V15.5L19 20.49L20.49 19L15.5 14ZM9.5 14C7.01 14 5 11.99 5 9.5C5 7.01 7.01 5 9.5 5C11.99 5 14 7.01 14 9.5C14 11.99 11.99 14 9.5 14Z" fill="white"/>
        </svg>
      </button>
    </div>
  </div>
  
  <div class="main-content-area">
    <aside class="filters-sidebar">
      <form method="get" action="{% url 'startups_list' %}" id="filter-form">
        <div class="filter-section">
          <h4>Категории</h4>
          <div class="category-filters">
            <label class="filter-checkbox">
              <input type="checkbox" name="category" value="med">
              <span class="checkbox-custom"></span> Медицина
            </label>
            <label class="filter-checkbox">
              <input type="checkbox" name="category" value="auto">
              <span class="checkbox-custom"></span> Автомобили
            </label>
            <!-- Добавьте остальные категории -->
          </div>
          <hr class="filter-divider">
        </div>
        <div class="filter-section">
          <div class="microinvestment-filter">
            <span>Микроинвестиции</span>
            <label class="switch">
              <input type="checkbox" name="microinvestment" value="true" {% if request.GET.microinvestment == 'true' %}checked{% endif %}>
              <span class="slider round"></span>
            </label>
            <span class="tooltip-icon" title="Включает стартапы, доступные для небольших инвестиций">?</span>
          </div>
        </div>
        <div class="filter-section">
          <h4>Рейтинг</h4>
          <div class="rating-slider-placeholder">
            <p>от {{ request.GET.min_rating|default:0 }} до {{ request.GET.max_rating|default:5 }}</p>
            <input type="hidden" name="min_rating" value="{{ request.GET.min_rating|default:0 }}">
            <input type="hidden" name="max_rating" value="{{ request.GET.max_rating|default:5 }}">
          </div>
          <div class="rating-inputs">
            <input type="text" name="min_rating_display" id="rating-min-display" value="{{ request.GET.min_rating|default:'0' }}" class="rating-input-display">
            <input type="text" name="max_rating_display" id="rating-max-display" value="{{ request.GET.max_rating|default:'5.0' }}" class="rating-input-display">
          </div>
        </div>
        <div class="filter-section filter-buttons">
          <button type="submit" class="filter-apply-button">Применить</button>
          <a href="{% url 'startups_list' %}" class="filter-reset-button">Сбросить</a>
        </div>
        {% if request.GET.sort %}
          <input type="hidden" name="sort" value="{{ request.GET.sort }}">
        {% endif %}
      </form>
    </aside>
    
    <main class="startup-list-container">
      {% if approved_startups %}
        <div class="startup-grid">
          {% for startup in approved_startups %}
            <div class="startup-card">
              <div class="form-row">
                <!-- Логотип и планета -->
                <div class="form-column" style="flex: 0 0 200px;">
                  <div class="planet-container">
                    <div class="planet">
                      <div class="planet-segment segment-top" style="background-color: {{ startup.planet_top_color }};"></div>
                      <div class="planet-segment segment-middle" style="background-color: {{ startup.planet_middle_color }};"></div>
                      <div class="planet-segment segment-bottom" style="background-color: {{ startup.planet_bottom_color }};"></div>
                    </div>
                    <div class="logo-overlay">
                      {% if startup.logo_url %}
                        <img src="{{ startup.logo_url }}" alt="{{ startup.title }} логотип" class="logo-preview">
                      {% else %}
                        <div class="logo-preview"></div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="small-text" style="text-align: center;">Планета стартапа</div>
                </div>

                <!-- Информация о стартапе -->
                <div class="form-column">
                  <div class="form-group">
                    <h3>{{ startup.title }}</h3>
                    <p>{{ startup.description|truncatechars:100 }}</p>
                  </div>
                  <div class="form-group">
                    <p><strong>Направление:</strong> {{ startup.direction_name }}</p>
                    <p><strong>Цель финансирования:</strong> {{ startup.funding_goal }} USD</p>
                    <p><strong>Стадия:</strong> {{ startup.stage_name }}</p>
                    <p><strong>Рейтинг:</strong> {{ startup.average_rating|floatformat:"1" }} / 5</p>
                  </div>
                  <div class="action-buttons">
                    <a href="{% url 'startup_detail' startup.startup_id %}" class="submit-button">Перейти к стартапу</a>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="no-startups-message">Нет доступных стартапов, соответствующих вашим фильтрам.</p>
      {% endif %}

      {% if page_obj and page_obj.has_other_pages %}
        <nav class="pagination" aria-label="Page navigation">
          <ul class="pagination-list">
            {% if page_obj.has_previous %}
              <li class="pagination-item">
                <a href="?page={{ page_obj.previous_page_number }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">« Пред.</a>
              </li>
            {% else %}
              <li class="pagination-item disabled"><span class="pagination-link">« Пред.</span></li>
            {% endif %}
            {% for i in page_obj.paginator.page_range %}
              {% if page_obj.number == i %}
                <li class="pagination-item active"><span class="pagination-link">{{ i }}</span></li>
              {% elif i > page_obj.number|add:'-3' and i < page_obj.number|add:'3' %}
                <li class="pagination-item">
                  <a href="?page={{ i }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">{{ i }}</a>
                </li>
              {% elif i == 1 and page_obj.number > 3 %}
                <li class="pagination-item">
                  <a href="?page=1{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">1</a>
                </li>
                <li class="pagination-item disabled"><span class="pagination-link">...</span></li>
              {% elif i == page_obj.paginator.num_pages and page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                <li class="pagination-item disabled"><span class="pagination-link">...</span></li>
                <li class="pagination-item">
                  <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">{{ page_obj.paginator.num_pages }}</a>
                </li>
              {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
              <li class="pagination-item">
                <a href="?page={{ page_obj.next_page_number }}{% for key, value_list in request.GET.lists %}{% for value in value_list %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}{% endfor %}" class="pagination-link">След. »</a>
              </li>
            {% else %}
              <li class="pagination-item disabled"><span class="pagination-link">След. »</span></li>
            {% endif %}
          </ul>
        </nav>
      {% endif %}
    </main>
  </div>
</div>
{% endblock %}
