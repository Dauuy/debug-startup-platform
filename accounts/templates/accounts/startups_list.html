{% extends 'accounts/base.html' %}
{% load static %}
{% load file_tags %}

{% block title %}Каталог стартапов{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'accounts/css/startups_list_styles.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Подключаем noUiSlider -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
  <!-- Подключаем wNumb для форматирования -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
{% endblock %}

{% block content %}
<div id="sidebar" class="menu-sidebar opened">
  <div id="outline">
    <!-- Боковая панель с фильтрами -->
    <div class="filters-sidebar">
      <div class="filters-menu">
        <select name="sort_order" id="sortOrder" form="filterForm">
          <option value="newest" {% if sort_order == 'newest' %}selected{% endif %}>Сначала новые</option>
          <option value="oldest" {% if sort_order == 'oldest' %}selected{% endif %}>Сначала старые</option>
        </select>
      </div>
      
      <h2 class="filter-heading">Категории</h2>
      
      <form method="get" id="filterForm">
        <ul class="category-list">
          {% for direction in directions %}
            {% for pair in direction_translations %}
              {% if pair.0 == direction.direction_name %}
                <li class="category-item">
                  <label class="category-label">
                    <input type="checkbox" name="category" value="{{ direction.direction_name }}" class="category-checkbox" {% if direction.direction_name in selected_categories %}checked{% endif %}>
                    <span class="category-name">{{ pair.1 }}</span>
                  </label>
                </li>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </ul>

        <!-- Слайдер для диапазона рейтинга (noUiSlider) -->
        <div class="rating-filter">
          <label class="rating-label">Рейтинг: <span id="ratingRangeValues">{{ min_rating|floatformat:1 }} - {{ max_rating|floatformat:1 }}</span></label>
          <div id="ratingRange" class="rating-slider"></div>
          <input type="hidden" name="min_rating" id="minRatingInput" value="{{ min_rating|floatformat:1 }}">
          <input type="hidden" name="max_rating" id="maxRatingInput" value="{{ max_rating|floatformat:1 }}">
        </div>
        
        <input type="hidden" name="micro_investment" id="microInvestmentInput" value="{% if micro_investment %}1{% else %}0{% endif %}">
        <input type="hidden" name="search" value="{{ search_query|default_if_none:'' }}">
        <input type="hidden" name="sort_order" value="{{ sort_order }}">

        <!-- Кнопка "Показать" -->
        <button type="submit" class="show-button">Показать</button>
      </form>

      <hr class="category-divider">
      
      <div class="admin-section">
        <span class="admin-label">Микроинвестиции</span>
        <div class="help-icon">?</div>
        <div class="toggle-switch" id="adminToggle" onclick="toggleMicroInvestment()" {% if micro_investment %}class="active"{% endif %}>
          <div class="toggle-handle {% if micro_investment %}toggle-handle-right{% else %}toggle-handle-left{% endif %}"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="page-container">
  {% if approved_startups %}
    <div class="pf" id="pf1" data-page-no="1">
      <div class="pc opened" id="pc1">
        <div class="startup-grid">
          {% for startup in approved_startups %}
            <a href="{% url 'startup_detail' startup.startup_id %}" class="startup-card-link">
              <div class="startup-card">
                <div class="startup-image">
                  {% if startup.logo_urls %}
                    <img src="{% get_file_url_tag startup.logo_urls.0 startup.startup_id 'logo' %}" alt="Изображение стартапа {{ startup.title }}" class="bi">
                  {% else %}
                    <div class="planet-container">
                      <div class="planet">
                        <div class="planet-segment segment-top color-default"></div>
                        <div class="planet-segment segment-middle color-default"></div>
                        <div class="planet-segment segment-bottom color-default"></div>
                      </div>
                    </div>
                  {% endif %}
                </div>
                <div class="startup-info">
                  <div class="startup-header">
                    <h3 class="startup-name t">{{ startup.title }}</h3>
                    <div class="rating-stars" data-rating="{{ startup.average_rating|default:0 }}">
                      {% for i in "12345" %}
                        <i class="fas fa-star {% if forloop.counter <= startup.average_rating|floatformat:0 %}active{% endif %}"></i>
                      {% endfor %}
                    </div>
                  </div>
                  <!-- Режим стартапа -->
                  <div class="startup-mode">
                    {% if startup.both_mode %}
                      Выкуп+инвестирование
                    {% elif startup.only_invest %}
                      Только инвестиции
                    {% elif startup.only_buy %}
                      Только выкуп
                    {% endif %}
                  </div>
                  <div class="startup-date">{{ startup.created_at|timesince }} назад</div>
                  <!-- Направление стартапа -->
                  <div class="startup-direction">
                    {% for pair in direction_translations %}
                      {% if pair.0 == startup.direction.direction_name %}
                        {{ pair.1 }}
                      {% endif %}
                    {% endfor %}
                  </div>
                  <div class="startup-description">
                    <p class="t">{{ startup.description }}</p>
                  </div>
                  <div class="card-footer">
                    <button class="details-button">Подробнее</button>
                    <div class="startup-likes">
                      <button class="like-button">
                        <i class="far fa-comment"></i>
                      </button>
                      <span class="like-count">{{ startup.comment_count|default:"0" }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    </div>
  {% else %}
    <div class="no-startups">
      <p>В настоящее время нет доступных стартапов. Загляните позже!</p>
    </div>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Проверка доступности noUiSlider
    if (typeof noUiSlider === 'undefined') {
      console.error('noUiSlider не загружен. Проверьте подключение библиотеки.');
      return;
    }

    // Проверка доступности wNumb
    if (typeof wNumb === 'undefined') {
      console.error('wNumb не загружен. Проверьте подключение библиотеки.');
      return;
    }

    // Инициализация noUiSlider для диапазона рейтинга
    var ratingRange = document.getElementById('ratingRange');
    var minRatingInput = document.getElementById('minRatingInput');
    var maxRatingInput = document.getElementById('maxRatingInput');
    var ratingRangeValues = document.getElementById('ratingRangeValues');

    // Предотвращаем повторную инициализацию
    if (ratingRange.noUiSlider) {
      ratingRange.noUiSlider.destroy();
      console.log('Слайдер уничтожен перед повторной инициализацией');
    }

    console.log('Инициализация noUiSlider');

    try {
      noUiSlider.create(ratingRange, {
        start: [parseFloat("{{ min_rating|floatformat:1 }}"), parseFloat("{{ max_rating|floatformat:1 }}")],
        connect: true,
        range: {
          'min': 0,
          'max': 5
        },
        step: 0.1,
        behaviour: 'drag',
        format: wNumb({
          decimals: 1,
          thousand: ''
        }),
        tooltips: [true, true],
        pips: {
          mode: 'steps',
          stepped: true,
          density: 5
        }
      });

      // Обновление значений при изменении слайдера
      ratingRange.noUiSlider.on('update', function(values, handle) {
        minRatingInput.value = values[0];
        maxRatingInput.value = values[1];
        ratingRangeValues.textContent = values[0] + " - " + values[1];
      });
    } catch (error) {
      console.error('Ошибка при инициализации noUiSlider:', error);
    }

    // Синхронизация рейтинга при загрузке страницы
    document.querySelectorAll('.rating-stars').forEach(function(stars) {
      var rating = parseFloat(stars.getAttribute('data-rating')) || 0;
      var starElements = stars.querySelectorAll('i');
      starElements.forEach(function(star, index) {
        if (index < Math.round(rating)) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    });

    // Автодополнение для поиска
    var searchInput = document.getElementById('searchInput');
    var suggestionsList = document.getElementById('searchSuggestions');

    if (searchInput && suggestionsList) {
      searchInput.addEventListener('input', function() {
        var query = searchInput.value;
        if (query.length < 2) {
          suggestionsList.innerHTML = '';
          suggestionsList.style.display = 'none';
          return;
        }

        fetch('/search-suggestions/?q=' + encodeURIComponent(query))
          .then(function(response) { return response.json(); })
          .then(function(data) {
            suggestionsList.innerHTML = '';
            if (data.suggestions.length > 0) {
              suggestionsList.style.display = 'block';
              data.suggestions.forEach(function(suggestion) {
                var div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', function() {
                  searchInput.value = suggestion;
                  suggestionsList.innerHTML = '';
                  suggestionsList.style.display = 'none';
                });
                suggestionsList.appendChild(div);
              });
            } else {
              suggestionsList.style.display = 'none';
            }
          })
          .catch(function(error) {
            console.error('Ошибка при получении предложений:', error);
            suggestionsList.style.display = 'none';
          });
      });

      // Скрываем список предложений при клике вне поля ввода
      document.addEventListener('click', function(event) {
        if (!searchInput.contains(event.target) && !suggestionsList.contains(event.target)) {
          suggestionsList.innerHTML = '';
          suggestionsList.style.display = 'none';
        }
      });
    }

    // Добавляем переключение меню для мобильных устройств
    var sidebar = document.getElementById('sidebar');
    var pageContainer = document.getElementById('page-container');
    
    function toggleMenu() {
      sidebar.classList.toggle('opened');
      if (sidebar.classList.contains('opened')) {
        pageContainer.style.left = '250px';
      } else {
        pageContainer.style.left = '0';
      }
    }
    
    // Добавляем кнопку для переключения меню на мобильных устройствах
    var menuToggle = document.createElement('button');
    menuToggle.className = 'menu-toggle';
    menuToggle.innerHTML = '<i class="fas fa-bars"></i>';
    menuToggle.addEventListener('click', toggleMenu);
    
    // Добавляем кнопку только на мобильных устройствах
    if (window.innerWidth <= 720) {
      document.body.appendChild(menuToggle);
    }
    
    window.addEventListener('resize', function() {
      if (window.innerWidth <= 720) {
        if (!document.querySelector('.menu-toggle')) {
          document.body.appendChild(menuToggle);
        }
        pageContainer.style.left = '0';
      } else {
        if (document.querySelector('.menu-toggle')) {
          document.querySelector('.menu-toggle').remove();
        }
        pageContainer.style.left = '250px';
      }
    });
  });

  // Обновление значения микроинвестиций без отправки формы
  function toggleMicroInvestment() {
    var toggleSwitch = document.getElementById('adminToggle');
    toggleSwitch.classList.toggle('active');
    
    var handle = toggleSwitch.querySelector('.toggle-handle');
    var microInvestmentInput = document.getElementById('microInvestmentInput');
    
    if (toggleSwitch.classList.contains('active')) {
      handle.classList.remove('toggle-handle-left');
      handle.classList.add('toggle-handle-right');
      microInvestmentInput.value = '1';
    } else {
      handle.classList.remove('toggle-handle-right');
      handle.classList.add('toggle-handle-left');
      microInvestmentInput.value = '0';
    }
  }
</script>
{% endblock %}